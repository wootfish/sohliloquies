---
layout: post
title: Virtualizing a Raspberry Pi with QEMU
date: '2016-10-17T07:15:00.003-07:00'
author: Eli Sohl
tags: 
modified_time: '2016-10-22T15:58:44.160-07:00'
blogger_id: tag:blogger.com,1999:blog-4261047698100656327.post-2909547015982081753
blogger_orig_url: http://sohliloquies.blogspot.com/2016/10/virtualizing-raspberry-pi-with-qemu.html
---

A while ago, I wrote about building a <a href="https://sohliloquies.blogspot.com/2015/12/making-raspberry-pi-cluster-part-1.html">rack</a> for a Raspberry Pi cluster. If you have a rack, at some point you'll want to put some Pis on it. Virtualization can make the process of imaging these Pis relatively painless. You can generate custom images from the comfort of your desktop and even automate the whole process. Here's a quick crash course in virtualizing the Pi using QEMU.<br /><br />All the guides I could find on this were at least a couple years old and were missing various important parts of the process. None of them quite worked out-of-the-box. It's hard to blame them, though, since a hardware platform like the Pi is of course a moving target. For what it's worth, this guide should be complete and up-to-date as of October 2016.<br /><br />The first thing to do is to get a base disk image to work from. It shouldn't make too much of a difference what you choose (unless you opt for something absurd and masochistic like <a href="https://wiki.archlinux.org/index.php/Raspberry_Pi">Arch Linux</a>). For this guide, I'll be using <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Lite</a>. My focus will be on emulating images compatible with the Pi 2, though I don't see why they wouldn't work on the Pi 3 as well.<br /><br />Once you've chosen a distro, download or torrent a .iso file for it. As soon as you have that, you can get started. I like to start by making a working copy of this .iso file right off the bat so that if I make a mistake I can just be throw it away and start over again from a fresh copy, without having to re-download the image.<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">mkdir -p ~/workspace/raspberry</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">cp ~/Downloads/2016-09-23-raspbian-jessie-lite.img ~/workspace/raspberry/raspbian.img</span><br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">raspbian.img</span> will serve as our base image. If you ever want to copy the current state of the virtualized Pi to an SD card, you can do that using <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">dd</span> from this file.<br /><br />We'll need a custom kernel to get QEMU to boot this Pi image. Currently <a href="https://github.com/dhruvvyas90/qemu-rpi-kernel">this github repo</a> maintains up-to-date kernel files for this purpose. Source code and a build script are included, if you're interested in those.<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">cd ~/workspace</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">git clone git@github.com:dhruvvyas90/qemu-rpi-kernel.git</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">cp qemu-rpi-kernel/kernel-qemu-4.4.13-jessie raspberry/kernel-qemu</span><br /><br />Now we have everything we need to boot up the Pi -- but if we do, it'll hit a kernel panic and dump core. That's no good. If you want to see this happen, then feel free to copy the qemu command from later on, but I'll warn you: it's not very exciting. What we're going to do now is make  a couple fixes to different config files so we can get things working.<br /><br />Before we apply these fixes, we need to be able to mount the Pi image's root partition. There's a hard way and an easy way to do this. The hard way involves reading the image's partition table, multiplying one of the fields in it by 512, and making a huge  "mount" invocation. The easy way is this:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">cd ~/workspace/raspberry</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sudo kpartx -va raspbian.img</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># note the name of the loop device chosen by kpartx, then...</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sudo mount /dev/mapper/loop0p2 /mnt&nbsp; # assuming kpartx chose loop0</span><br /><br />kpartx does all the work for us, reading the image's partition table and creating loop devices for its partitions. The first one is the Pi's boot partition and the second one is its root filesystem. So following this process gives us the Pi's root filesystem mounted to /mnt. No mess no stress!<br /><br />Now, here's what we've got to change. First, edit <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/mnt/etc/ld.so.preload</span> and comment out its first and only line by prepending a <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#</span> to it:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#/usr/lib/arm-linux-gnueabihf/libarmmem.so</span><br /><br />This prevents the kernel panic. I have no idea why.<br /><br />Next, create a new file: <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/mnt/etc/udev/rules.d/90-qemu.rules</span><br />and put the following lines into it:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">KERNEL=="sda", SYMLINK+="mmcblk0"<br />KERNEL=="sda?", SYMLINK+="mmcblk0p%n",</span><br /><br />These are necessary because (<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/mnt</span>)<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/etc/fstab</span> specifies partitions under <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/dev/mmcblk0</span> for critical parts of the filesystem. That would make sense for Raspbian under normal circumstances because it boots from an SD card, but since we're exposing our disk image to the system as <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/dev/sda</span>, we need to add these mappings if we want to keep everyone happy. You could of course also edit <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/etc/fstab</span> to specify <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sda</span> instead of <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">mmcblk0</span>, but that would break compatibility between the image and actual Pis.<br /><br />These two fixes should be enough to get Raspbian to boot cleanly. If you want to use SSH to access the Pi from the host machine, you can optionally set that up as well  by disabling password login (which actually is good to do anyway) and adding your public key to authorized_keys. If you don't already have a public key, you will of course need to run <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">rsa-keygen</span> first. Then,<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">echo "PasswordAuthentication no" &gt;&gt; /mnt/etc/ssh/sshd_config</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">mkdir -p /mnt/home/pi/.ssh</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">cat ~/.ssh/id_rsa.pub &gt;&gt; /mnt/home/pi/.ssh/authorized_keys</span><br /><br />And you'll be good to go. This disables password authentication but grants passwordless access to anyone in possession of your private key.<br /><br />You should also unmount <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/mnt</span> at this point:<br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sudo umount /mnt</span> <br />This may not be strictly necessary but it  seems like common sense given that <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/mnt</span> is mounted from a partition on the image file we're about to give to QEMU. Under certain circumstances, leaving a partition mounted while also using it with QEMU runs the risk of corrupting the filesystem.<br /><br />Now, the moment has arrived -- we're going to actually boot up our virtual Pi! Here's the invocation: <br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">qemu-system-arm -kernel kernel-qemu -cpu arm1176 -m 256 -M versatilepb -no-reboot -serial stdio -append "root=/dev/sda2 panic=<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">1</span>" -hda raspbian.img -redir tcp:5022::22</span><br /><br /><span style="font-family: inherit;">Th<span style="font-family: inherit;">at</span> shoul<span style="font-family: inherit;">d work to boot <span style="font-family: inherit;">to a <span style="font-family: inherit;">login prompt. <span style="font-family: inherit;">The default login is<span style="font-family: inherit;">:</span></span></span></span></span></span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">Username -<span style="font-family: inherit;"> <span style="font-family: inherit;">pi</span></span></span></span></span></span></span></span></span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">Pas<span style="font-family: inherit;">sword - raspberry</span></span></span></span></span></span></span></span></span></span><br /><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">If you didn't di<span style="font-family: inherit;">sable <span style="font-family: inherit;">password authentication for SSH earlier<span style="font-family: inherit;"> <span style="font-family: inherit;">then you <span style="font-family: inherit;">should change this <span style="font-family: inherit;">password as soon as you log in.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br /><br /><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">For education's sake, l</span></span>et's break down <span style="font-family: inherit;">the</span> different parts of that <span style="font-family: inherit;">QEMU</span> invocatio<span style="font-family: inherit;">n:</span></span></span></span></span></span></span></span></span></span><br /><ul><li><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">Since the Pi is an ARM system, you naturally invoke <span style="font-family: inherit;">QEMU's </span>ARM <span style="font-family: inherit;">emulator</span>.</span></span></span></span></span></span></span></span></span></span></li><li><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">We pass it t<span style="font-family: inherit;">he kernel image we <span style="font-family: inherit;">obtained from <span style="font-family: inherit;">Github earlier.</span></span></span></span>&nbsp;</span></span></span></span></span></span></span></span></span></li><li><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">We specify the CPU <span style="font-family: inherit;">model</span> <span style="font-family: inherit;">as arm1176<span style="font-family: inherit;">, and we give the device 256<span style="font-family: inherit;">M of <span style="font-family: inherit;">RAM.</span></span></span></span></span></span></span></span></span></span></span></span></span></li><li><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">The <span style="font-family: inherit;"><span style="font-family: inherit;">ARM board type we <span style="font-family: inherit;">specify as <span style="font-family: inherit;">VersatilePB</span><span style="font-family: inherit;">.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li><li><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">-no-reboot</span><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"> is necessary because <span style="font-family: inherit;">without it,</span></span> running commands such as <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">s</span><span style="font-family: inherit;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">udo shutdown -h </span><span style="font-family: inherit;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">now</span> in the guest <span style="font-family: inherit;">would not in fact shut <span style="font-family: inherit;">down the <span style="font-family: inherit;">virtual sy</span>stem<span style="font-family: inherit;"> but <span style="font-family: inherit;">would instead reboot it</span>. Not sure why.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li><li><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">We specify <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">-serial s</span><span style="font-family: inherit;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">tdio</span> to allow <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">stdin/std</span><span style="font-family: inherit;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">out</span> to be used for a serial connection. Thi<span style="font-family: inherit;">s isn't strictly necessary as far as I know but<span style="font-family: inherit;"> it<span style="font-family: inherit;">'s <span style="font-family: inherit;">widely included in e<span style="font-family: inherit;">xamples, and it would c<span style="font-family: inherit;">ertainl<span style="font-family: inherit;">y be <span style="font-family: inherit;">useful for scripting interactions with the guest OS.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li><li><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">-appe</span><span style="font-family: inherit;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">nd</span> allows us to pass kernel parameters<span style="font-family: inherit;"> <span style="font-family: inherit;">to <span style="font-family: inherit;">the guest. </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="font-family: inherit;">We specify <span style="font-family: inherit;">the <span style="font-family: inherit;">"disk" partition it should mount as ro<span style="font-family: inherit;">ot, and we tell <span style="font-family: inherit;">the system <span style="font-family: inherit;">to reboot after 1 second on kernel panic. You can replace this wit<span style="font-family: inherit;">h a larger integer<span style="font-family: inherit;"> to <span style="font-family: inherit;">wait longer, with 0 to hang on panic, </span></span></span></span></span><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">or with a negative number <span style="font-family: inherit;">to make <span style="font-family: inherit;">kernel panics cause an instant reboot.</span><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li><li><span style="font-family: inherit;">We also of course specify our working copy of the Raspbian <span style="font-family: inherit;">i<span style="font-family: inherit;">mage file<span style="font-family: inherit;"> as th<span style="font-family: inherit;">e system<span style="font-family: inherit;">'s </span>primary hard drive.</span></span></span></span></span></li><li><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;"><span style="font-family: inherit;">Lastly, we<span style="font-family: inherit;"> set <span style="font-family: inherit;">up some port forwarding to allow us to connect over SSH from the host. <span style="font-family: inherit;">Port 5022 on the host <span style="font-family: inherit;">will be redirected to <span style="font-family: inherit;">port 22 on the Pi.</span></span><span style="font-family: inherit;"></span></span></span></span> <span style="font-family: inherit;">That lets</span> you  ssh to the <span style="font-family: inherit;">guest <span style="font-family: inherit;">from the host like this:</span></span></span></span></span></span></span> <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">ssh -p 5022 pi@localhost</span></li></ul><br />If you want to copy your configured Pi image to a SD card, you can simply plug  in the card, use <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">dmesg</span> to find the name of its block device (we'll assume here that it's <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/dev/mmcblk0</span>), and then write from the image file to this block device using <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">dd</span>:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sudo dd if=raspbian.img of=/dev/mmcblk0 bs=4M status=progress</span><br /><br />And once that completes, your SD card should be all set! Note that you'll probably want to expand the filesystem once you've finished writing to the Pi, since the SD card's max size is likely a fair bit larger than this disk image. On Raspbian, the <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">raspi-config</span> utility provides a helper tool for doing that.<br /><br />So, that just about does it for using QEMU to virtualize a Raspberry Pi and create custom SD card images! If there's anything you'd like to add, feel free to leave a comment below.